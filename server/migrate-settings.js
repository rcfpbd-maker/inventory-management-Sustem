import mysql from "mysql2/promise";
import dotenv from "dotenv";
dotenv.config();

async function migrate() {
    const connection = await mysql.createConnection({
        host: process.env.DB_HOST || "localhost",
        user: process.env.DB_USER || "root",
        password: process.env.DB_PASSWORD || "123456",
        database: process.env.DB_NAME || "ims_v2",
    });

    console.log("Starting settings migration...");

    await connection.query(`
    CREATE TABLE IF NOT EXISTS settings (
      id INT PRIMARY KEY DEFAULT 1,
      shop_name VARCHAR(255) DEFAULT 'IMS Store',
      shop_email VARCHAR(255) DEFAULT 'contact@ims.com',
      shop_phone VARCHAR(50) DEFAULT '0123456789',
      shop_address TEXT,
      currency_symbol VARCHAR(10) DEFAULT '৳',
      footer_text TEXT,
      low_stock_threshold INT DEFAULT 10,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
      CONSTRAINT single_row CHECK (id = 1)
    )
  `);

    const [rows] = await connection.query("SELECT * FROM settings WHERE id = 1");
    if (rows.length === 0) {
        await connection.query(`
      INSERT INTO settings (id, shop_name, shop_email, shop_phone, shop_address, currency_symbol, footer_text, low_stock_threshold)
      VALUES (1, 'IMS Store', 'contact@ims.com', '0123456789', 'Main Street, Dhaka', '৳', 'Generated by IMS', 10)
    `);
        console.log("Default settings inserted.");
    }

    console.log("Settings migration completed.");
    await connection.end();
}

migrate().catch(console.error);
